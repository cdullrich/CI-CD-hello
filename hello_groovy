node('master')
{
    timestamps{
        try {
            stage ('Cleanup Workspace') {
                echo "Cleaning workspace: ${env.WORKSPACE}"
                deleteDir()
            }
            stage ('Checkout Hello Code')
            {
                echo "checking out code"
                git url: 'https://github.com/cdullrich/CI-CD-hello/'
            }
            stage ('make a sandwich')
            {
                echo "I am so hungry, I need a sandwich!"
            }
            stage ('build Go code')
            {
                echo "building application"
                sh 'go get github.com/gorilla/mux'
                sh 'env GOOS=linux GOARCH=amd64 go build -o HomeAdvisor'
            }
            stage ('dockerize build')
            {
                echo "dockerizing build"
                sh 'docker build -t hello-advisor .'
            }
            stage ('eat the sandwich')
            {
                echo "This sandwich is going to taste so good! Nomnomnomnom!"
            }
            stage ('test build')
            {
                echo "verifying build's expected http response"
                sh 'docker run -p 3000:3000 hello-advisor'
                def http_test = sh 'curl http://localhost:3000'
                if (http_test.content != 'Hello, HomeAdvisor!') {
                    error "Pipeline aborted due to failed GoLang API test. HTTP content from test: ${http_test.content}"
                }
            }
            stage ('publish to artifactory')
            {
                echo "we don't actually have artifactory linked up, but we would do it here"
            }
            stage ('deploy to cluster')
            {
                echo "deploying build to production (let's do this last)"
            }
        }
        catch (err) {
            echo "woopsie doopsie: ${err}"
            sh 'docker container stop $(docker container list -q)'
            currentBuild.result = 'FAILURE'
        }
    }
}


